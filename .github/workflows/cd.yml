name: Continuous Deployment - Build and Deploy to GKE

on:
  push:
    branches:
      - main

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: ${{ secrets.GAR_LOCATION }}
  GAR_REPOSITORY: ${{ secrets.GAR_REPOSITORY_NAME }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}
  IMAGE_NAME: iris-api

jobs:
  build-and-push-image:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Set up Cloud SDK
      uses: 'google-github-actions/setup-gcloud@v2'

    - name: Configure Docker
      run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

    # This step writes the secret to a temp file
    - name: Write SA key to file
      run: echo '${{ secrets.GCP_SA_KEY }}' > gcp_sa_key.json

    - name: Build Docker Image
      run: |
        # This command uses BuildKit to securely pass the secret file
        # The secret is available inside the Dockerfile at RUN --mount=type=secret,id=gcp-sa-key
        DOCKER_BUILDKIT=1 docker build \
          --secret id=gcp-sa-key,src=gcp_sa_key.json \
          -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          .

    # This step cleans up the temporary key file
    - name: Remove SA key file
      if: always() # Always run this step, even if the build fails
      run: rm -f gcp_sa_key.json

    - name: Push Docker Image to GAR
      run: docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy-to-gke:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build-and-push-image
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Set up GKE credentials
      uses: 'google-github-actions/get-gke-credentials@v2'
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_ZONE }}
        
    - name: Prepare K8s Manifest
      run: |
        sed -i "s|IMAGE_PLACEHOLDER|${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}|g" k8s/deployment.yml
        echo "--- Updated k8s/deployment.yml: ---"
        cat k8s/deployment.yml
        
    - name: Deploy to GKE
      run: |
        kubectl apply -f k8s/deployment.yml
        echo "Deployment started. Waiting for rollout to complete..."
        kubectl rollout status deployment/iris-api-deployment --timeout=120s
        
    - name: Show Service IP
      run: |
        echo "Deployment successful! Wait a minute for the LoadBalancer IP to be assigned."
        kubectl get service iris-api-service


